pipeline {
    agent any
    // triggers { upstream(upstreamProjects: 'jenkins_pipeline_example', threshold: hudson.model.Result.SUCCESS) }
    options {
        timestamps()
        disableConcurrentBuilds()
        timeout(time: 10, unit: 'SECONDS')
    }
    parameters {
        // Parallel Stage parameters
        booleanParam(name: 'RunParallelStage', defaultValue: false, description: 'Run Parallel Stage')
        string(name: 'SleepDelay', defaultValue: '1', description: 'Sleep delay inside timeout')
        string(name: 'shCmd', defaultValue: 'true', description: 'sh command to run')
        // Matrix Stage parameters
        booleanParam(name: 'RunMatrixStage', defaultValue: false, description: 'Run Matrix Stage')
        // Stash Stage parameters
        booleanParam(name: 'RunStashStage', defaultValue: true, description: 'Run Stash Stage')
        // Misc
        choice(name: 'choice', choices: ['one','two','three'], description: '')
        password(name: 'password', defaultValue: 'SECRET', description: '')
        text(name: 'text', defaultValue: 'One\nTwo\nThree\n', description: '')
    }
    stages {
       // --------------------------------------------------------------------
       stage("Parallel") {
            when {
                expression {return params.RunParallelStage}
            }
            failFast true
            parallel {
                stage("One") {
                    agent any
                    // run on a new agent
                    steps {
                        echo "${NODE_NAME}"
                        sleep 1
                        echo 'Stage 1'
                    }
                }
                stage("Two") {
                    options {
                        timeout(time: 2, unit: 'SECONDS')
                    }
                    steps {
                        echo "${NODE_NAME}"
                        // Use integer parameter
                        sleep params.SleepDelay.toInteger()
                        echo 'Stage 2'
                    }
                }
                stage("Three") {
                    options {
                        retry(2)
                    }
                    steps {
                        echo 'Stage 3'
                        sh "${params.shCmd}"
                    }
                }
            }
        }
        // --------------------------------------------------------------------
        stage("Matrix") {
            when {
                expression {return params.RunMatrixStage}
            }
            matrix {
                agent {
                    node {
                        label "${PLATFORM}"
                    }
                }
                axes {
                    axis {
                        name 'PLATFORM'
                        // values 'ubuntu20.04', 'ubuntu', 'centos7'
                        values 'oci1', 'master'
                    }
                }
                stages {
                    stage('One') {
                        steps {
                            sleep 1
                            echo "$PLATFORM - stage 1"
                        }
                    }
                }
            }
        }
        // --------------------------------------------------------------------
        stage("StashOne") {
            when {
                expression {return params.RunStashStage}
            }
            steps {
                echo "node $NODE_NAME"
                sh "rm -f *.tmp"
                writeFile file: "a.tmp", text: "${NODE_NAME}"
                sh "ls *.tmp"
                stash includes: "a.tmp", name: 'stash_one'
            }
        }
        stage ("StashTwo") {
            when {
                expression {return params.RunStashStage}
            }
            agent any
            steps {
                echo "node $NODE_NAME"
                sh "rm -f *.tmp"
                sh "ls"
                unstash 'stash_one'
                sh "ls"
                writeFile file: "a.tmp", text: "${NODE_NAME}"
                stash includes: "b.tmp", name: 'stash_one'
            }
        }
        stage("StashThree") {
            when {
                expression {return params.RunStashStage}
            }
            steps {
                echo "node $NODE_NAME"
                sh "rm -f *.tmp"
                sh "ls"
                unstash 'stash_one'
                sh "ls"
            }
        }
    }
}
